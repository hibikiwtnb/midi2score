# 自動左右手分離功能邏輯說明

本文件說明 `midi2Score` 工具中自動左右手分離功能的內部實作邏輯。該功能主要由 `modules/hand_splitter.py` 模組負責。

## 核心理念

基於**同手可彈音符組**的概念，將MIDI音符按演奏可行性分組，然後以組為單位進行左右手分配。這種方法更符合實際鋼琴演奏的物理限制和音樂邏輯。

## 核心流程

自動左右手分離的過程分為以下主要步驟：

### 1. MIDI檔案讀取與音符提取
- 載入MIDI檔案，提取所有音符事件（`note_on`、`note_off`）
- 計算每個事件的絕對時間
- 收集所有帶有力度的`note_on`事件用於分組分析

### 2. 智能音符分組（核心創新）
檢測**同手可彈音符組**，基於兩個條件：
- **時間條件**：音符之間的時間差在32分音符時間差內（`ticks_per_beat/8`）
- **音域條件**：組內音符的音域跨度不超過一個八度（12個半音）

分組算法：
```
對於每個未處理的音符：
1. 作為新組的起始音符
2. 迭代查找可加入的候選音符：
   - 時間差 ≤ 32分音符時間差
   - 加入後音域跨度 ≤ 12個半音
3. 重複直到無法再添加音符
```

### 3. 組級別的左右手分配
對每個音符組進行智能分手判斷：

#### 3.1 基本規則
- **全部低於中央C**：分配給左手
- **全部高於等於中央C**：分配給右手

#### 3.2 跨域組的智能處理
當組內音符跨越中央C時，採用以下邏輯：

1. **MIDI命名標準兼容性**（重要特性）：
   ```
   如果組包含中央C(60)且最低音≤A3(57)：
   → 分配給左手
   ```
   **背景說明**：不同DAW對中央C的命名存在差異：
   - MIDI標準/Logic Pro：中央C = C3 (MIDI音高60)
   - Roland/Korg標準：中央C = C4 (MIDI音高60)

2. **強左手偏置**：
   ```
   如果最低音 < 49：
   → 分配給左手
   ```

3. **距離比較**：
   ```
   比較最高音和最低音與中央C的距離：
   - 高音距離更遠 → 右手
   - 低音距離更遠或等距 → 左手
   ```

### 4. note_off事件的一致性處理
- 追蹤活躍的`note_on`事件及其手部分配
- 確保每個`note_off`事件與對應的`note_on`分配到相同的手
- 對於孤立的`note_off`事件，使用基於中央C的預設分配

### 5. MIDI軌道重建
根據用戶配置進行軌道和聲道分配：

#### 5.1 同軌道模式（預設）
當`left_track == right_track`時：
- 所有音符事件寫入同一軌道
- 使用不同MIDI聲道區分左右手：
  - 左手：`left_channel - 1`（預設0）
  - 右手：`right_channel - 1`（預設2）

#### 5.2 分軌道模式
當`left_track != right_track`時：
- 左右手音符分別寫入不同軌道
- 仍使用指定的聲道設定

## 核心優勢

### 1. 音樂邏輯性
- 基於同手可彈的概念，符合實際演奏限制
- 避免單手演奏跨度過大的和弦

### 2. MIDI命名標準兼容性
- 處理不同DAW中央C命名約定的差異（C3 vs C4）
- 解決由命名差異導致的分手錯誤，確保音樂邏輯正確

### 3. 時間精確性
- 使用32分音符精度進行時間分組
- 確保音樂節奏的準確性

### 4. 可配置性
- 支援自定義軌道和聲道配置
- 適應不同的MIDI輸出需求

## 技術參數

| 參數 | 數值 | 說明 |
|------|------|------|
| `pivot` | 60 | 中央C的MIDI音高編號 |
| `max_time_diff` | `ticks_per_beat/8` | 32分音符的時間差閾值 |
| `max_pitch_span` | 12 | 一個八度的半音數 |
| `logic_pro_threshold` | 57 | Logic Pro兼容性的音高閾值(A3) |

## 實際應用效果

此演算法特別適用於：
- AI生成的鋼琴MIDI檔案
- 結構清晰的鋼琴獨奏作品
- 需要考慮DAW兼容性的場景
- 對演奏可行性有要求的五線譜輸出

通過這種基於組的智能分手方法，系統能夠產生更符合人類演奏習慣和音樂邏輯的左右手分配結果。
