# 自動左右手分離功能邏輯說明

本文件說明 `midi2Score` 工具中自動左右手分離功能的內部實作邏輯。該功能主要由 `modules/hand_splitter.py` 模組負責。

## 核心流程

自動左右手分離的過程可以概括為以下幾個主要步驟：

1.  **MIDI 檔案讀取與音符提取**：
    *   首先，程式會載入使用者提供的 MIDI 檔案。
    *   遍歷 MIDI 檔案中的所有音軌，提取出所有的 MIDI 事件，並計算每個事件的絕對時間。主要關注 `note_on`（音符開始）和 `note_off`（音符結束）事件，以及它們的音高、力度和時間訊息。所有事件被收集到一個列表中。

2.  **初步手部指派 (Initial Hand Assignment)**：
    *   設定一個「樞軸音高」(pivot pitch)，預設為中央 C (C4，MIDI 音高編號為 60)。
    *   對於每一個 `note_on` 和 `note_off` 事件：
        *   根據音符的音高與此樞軸音高比較，進行初步的左右手分配。
        *   音高 **低於** 樞軸音高的音符，初步分配給 **左手**。
        *   音高 **高於或等於** 樞軸音高的音符，初步分配給 **右手**。
    *   此階段的 `note_off` 分配也是基於音高。其與對應 `note_on` 事件的一致性將在後續步驟中專門處理。
    *   所有事件依絕對時間排序。

3.  **音符分組 (Note Grouping for Rebalancing Chords)**：
    *   為了處理和弦內的音符分配，程式會對幾乎同時發生的 `note_on` 事件進行分組。
    *   使用一個時間閾值（`threshold_ticks`，根據 MIDI 檔案的 `ticks_per_beat` 計算，大約對應 50 毫秒）來判斷音符是否屬於同一個「音符事件組」（即和弦）。
    *   只考慮帶有力度的 `note_on` 事件進行分組。

4.  **和弦內部分手調整與再平衡 (Rebalancing within Chords)**：
    *   此步驟的目的是解決初步分配可能導致單手在和弦中負荷過重的問題。
    *   **最大音符數限制**：定義每隻手在一個和弦內可以合理演奏的最大音符數量 (`max_notes_per_hand`，程式碼中設為 4)。
    *   **迭代調整邏輯**：針對每個和弦組：
        *   如果和弦組音符數大於 1，則進行檢查和調整。
        *   檢查 **左手** 的 `note_on` 音符數量是否超過 `max_notes_per_hand`。如果是，則將左手中 **音高最高** 的一個或多個音符重新分配給右手，直到左手音符數量達標。
        *   檢查 **右手** 的 `note_on` 音符數量是否超過 `max_notes_per_hand`。如果是，則將右手中 **音高最低** 的一個或多個音符重新分配給左手，直到右手音符數量達標。
        *   這個調整過程會迭代進行（有最大迭代次數限制，以防無限循環），直到該和弦組內雙手的 `note_on` 音符分配均不超過限制，或無法再透過移動音符改善平衡。
        *   此階段的調整僅更新 `note_on` 事件的手部歸屬。

5.  **確保 `note_off` 事件手部一致性**：
    *   在和弦調整完成後，此步驟確保每個 `note_off` 事件（或力度為0的 `note_on` 事件）被分配到與其對應的 `note_on` 事件相同的手部。
    *   程式通過追蹤活躍的（已觸發但尚未釋放的） `note_on` 事件及其手部歸屬來實現。當遇到 `note_off` 事件時，會查找其對應的 `note_on` 事件所記錄的手部，並將 `note_off` 事件分配給同一隻手。
    *   如果找不到對應的 `note_on` 事件（例如孤立的 `note_off`），則會依據樞軸音高規則進行預設分配。

6.  **音符時間排序與 MIDI 軌道/聲道重建**：
    *   所有 MIDI 事件（包括手部分配更新後的音符事件及原始 MIDI 中的其他非音符事件）會再次按照絕對時間進行最終排序。
    *   程式會創建一個新的 MIDI 檔案結構。
    *   **軌道與聲道分配**：
        *   新 MIDI 檔案將包含的音軌數量，取決於使用者指定的 `left_track` 和 `right_track` 參數中的較大值（預設情況下，`left_track=1`, `right_track=1`，因此通常是一個主要音軌）。
        *   所有經過手部分離處理的音符事件（`note_on`, `note_off`）以及原始 MIDI 中的其他相關事件（除了軌道結束標記 `end_of_track`），都會被寫入到由 `left_track` 參數指定的 **單一音軌** 中（預設為第一個音軌，即索引為 `left_track - 1` 的音軌）。
        *   在該主要音軌內，左右手的音符是通過 **MIDI 頻道 (Channel)** 來區分的：
            *   被分配到 **左手** 的音符事件，其 MIDI 頻道會被設定為 `left_channel - 1` (使用者指定的 `left_channel` 預設為 1，對應程式內部使用的頻道 0)。
            *   被分配到 **右手** 的音符事件，其 MIDI 頻道會被設定為 `right_channel - 1` (使用者指定的 `right_channel` 預設為 3，對應程式內部使用的頻道 2)。
        *   因此，即使 `left_track` 和 `right_track` 參數設定為不同的軌道號，當前實現仍會將所有手分音符合併到 `left_track` 所指向的軌道，並用頻道來區分左右手。其他因 `right_track` 數值更大而創建的軌道則可能為空。
    *   最後，為每個音軌添加 `end_of_track` 元事件。

7.  **輸出結果**：
    *   最終，程式會產生一個新的 MIDI 檔案。此檔案將包含 `max(left_track, right_track)` 個音軌。
    *   其中，由 `left_track` 參數指定的音軌（預設為第一個音軌）會包含所有經過左右手分離處理的音符事件，以及來自原始 MIDI 的其他相關事件。
    *   在這個主要音軌內，左右手的音符是通過不同的 **MIDI 頻道 (Channel)** 來清晰區分的，而非主要通過不同的音軌。
    *   若 `max(left_track, right_track)` 大於1且大於 `left_track` 所指定的軌道索引，則其他創建的音軌將不包含手分音符，可能為空。

## 可配置參數（潛在）

雖然目前版本中某些參數是硬編碼的，但以下參數在理論上可以被設計為可由使用者配置，以適應不同風格或複雜度的音樂：

*   `pivot_pitch`：初始左右手分割點。
*   `grouping_threshold`：定義和弦的時間窗口。
*   `max_notes_per_hand`：單手最大同時發聲數。

## 總結

該自動分手邏輯通過結合基於固定音高的初步劃分和基於和弦內音符數量限制的動態調整，力求在大多數情況下模擬出符合人類演奏習慣的左右手分配。其效果對於結構清晰、聲部明確的鋼琴獨奏AI生成MIDI尤為有效。
